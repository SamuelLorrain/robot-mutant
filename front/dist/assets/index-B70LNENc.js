var V=Object.defineProperty;var $=(n,t,e)=>t in n?V(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var r=(n,t,e)=>$(n,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))s(i);new MutationObserver(i=>{for(const a of i)if(a.type==="childList")for(const h of a.addedNodes)h.tagName==="LINK"&&h.rel==="modulepreload"&&s(h)}).observe(document,{childList:!0,subtree:!0});function e(i){const a={};return i.integrity&&(a.integrity=i.integrity),i.referrerPolicy&&(a.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?a.credentials="include":i.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(i){if(i.ep)return;i.ep=!0;const a=e(i);fetch(i.href,a)}})();class o{constructor(t=0,e=0){r(this,"x");r(this,"y");t instanceof o?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e)}set(t,e=0){t instanceof o?(this.x=t.x,this.y=t.y):(this.x=t,this.y=e)}add(t){return new o(this.x+t.x,this.y+t.y)}sub(t){return new o(this.x-t.x,this.y-t.y)}mul(t){return new o(this.x*t,this.y*t)}eq(t){return this.x===t.x&&this.y===t.y}almostEq(t,e){return Math.abs(this.x-t.x)<=e&&Math.abs(this.y-t.y)<=e}hash(){return JSON.stringify([this.x,this.y])}static unhash(t){const e=JSON.parse(t);return new o(e[0],e[1])}map(t){return new o(t(this.x),t(this.y))}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}normalize(){const t=this.length();return new o(this.x/t,this.y/t)}distance(t){return Math.sqrt(Math.pow(t.x-this.x,2)+Math.pow(t.y-this.y,2))}}class b{constructor(t,e,s){r(this,"_picture");r(this,"_sizeSprite");r(this,"_spritesPerDimension");this._picture=t,this._sizeSprite=e,this._spritesPerDimension=s}getSpritePosition(t){const e=t%this._spritesPerDimension.x,s=Math.floor(t/this._spritesPerDimension.x);return new o(e*this._sizeSprite.x,s*this._sizeSprite.y)}get sizeOfSprite(){return new o(this._sizeSprite)}get picture(){return this._picture}}class M extends Error{constructor(){super(...arguments);r(this,"name","UIException")}}class N extends M{constructor(t){super(t),this.name="Context2DException"}}class tt extends M{constructor(t){super(t),this.name="ImageDataException"}}class et extends M{constructor(t){super(t),this.name="PictureException"}}class m{constructor(t,e,s){r(this,"_image_bitmap");r(this,"_blob");r(this,"_imageData");this._image_bitmap=t,this._blob=e,this._imageData=s}static async createFromUri(t){const s=await(await fetch(t)).blob(),i=await this.bitmapFromBlob(s),a=this.imageDataFromBitmap(i);return new m(i,s,a)}static async createFromBlob(t){const e=await this.bitmapFromBlob(t),s=this.imageDataFromBitmap(e);return new m(e,t,s)}static async bitmapFromBlob(t){try{return window.createImageBitmap(t,{resizeQuality:"pixelated"})}catch(e){throw new tt(`Unable to create ImageBitmap:  ${e.toString()}`)}}static imageDataFromBitmap(t){const e=document.createElement("canvas");e.width=t.width,e.height=t.height;const s=e.getContext("2d");if(s==null)throw new et("Unable to fetch Context2d while creating imageData from bitmap");return s.drawImage(t,0,0),s.getImageData(0,0,t.width,t.height)}get bitmap(){return this._image_bitmap}get blob(){return this._blob}get imageData(){return this._imageData}}const st="/assets/tiles-Ca7DXaQe.png",it="data:image/png;base64,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",rt="/assets/perso-blue-sprite-CjjCAwUI.png",nt="/assets/perso-red-sprite-J104xnyJ.png";function at(n){return{durationMs:-1,spriteNb:n}}class O{constructor(t,e){r(this,"_spriteSheet");r(this,"_timeline");r(this,"_ticks");r(this,"_paused");r(this,"_spriteNb");r(this,"_timelineFrame");this._spriteSheet=t,this._spriteNb=e[0].spriteNb??0,this._timeline=e,this._timelineFrame=0,this._ticks=0,this._paused=!1}get spriteSheet(){return this._spriteSheet}get spriteNb(){return this._spriteNb}get ticks(){return this._ticks}set ticks(t){this._ticks=t,this.updateSpriteAccordingToTimeline()}restart(){this._ticks=0}set paused(t){this._paused=t}updateTimeline(t){this._paused||this._timeline.length===0||(this._ticks+=t,this.updateSpriteAccordingToTimeline())}updateSpriteAccordingToTimeline(){this._ticks>=this._timeline[this._timelineFrame].durationMs&&(this._ticks=this._ticks%this._timeline[this._timelineFrame].durationMs,this._timelineFrame=(this._timelineFrame+1)%this._timeline.length,this._spriteNb=this._timeline[this._timelineFrame].spriteNb)}}const ot=async()=>{const n=new Map,t=new b(await m.createFromUri(st),new o(64,64),new o(4,4));n.set("tiles",t);const e=new b(await m.createFromUri(it),new o(64,64),new o(4,4));n.set("cursor",e);const s=new b(await m.createFromUri(rt),new o(64,64),new o(8,8));n.set("blue",s);const i=new b(await m.createFromUri(nt),new o(64,64),new o(8,8));return n.set("red",i),n},P=(n,t)=>t.map(e=>typeof e=="number"?new O(n,[at(e)]):new O(n,e));class ht{constructor(){r(this,"_startTicks");r(this,"_pausedTicks");r(this,"_isPaused");r(this,"_isStarted");r(this,"_deltaLastGetTicks",0);r(this,"_lastGetTicks",0);this._startTicks=0,this._pausedTicks=0,this._isPaused=!1,this._isStarted=!1,this._deltaLastGetTicks=0,this._lastGetTicks=0}start(t=null){this._isStarted=!0,this._isPaused=!1,t==null?this._startTicks=performance.now():this._startTicks=t,this._pausedTicks=0}stop(){this._isStarted=!1,this._isPaused=!1,this._startTicks=0,this._pausedTicks=0,this._lastGetTicks=0}pause(){this._isStarted&&!this._isPaused&&(this._isPaused=!0,this._pausedTicks=performance.now()-this._startTicks,this._startTicks=0)}unpause(){this._isStarted&&this._isPaused&&(this._isPaused=!1,this._startTicks=performance.now()-this._pausedTicks,this._pausedTicks=0)}getTicks(){let t=-1;return this._isStarted&&(this._isPaused?t=this._pausedTicks:t=performance.now()-this._pausedTicks),this._deltaLastGetTicks=t-this._lastGetTicks,this._lastGetTicks=t,t}getDeltaLastGetTicks(){return this._deltaLastGetTicks}get isPaused(){return this._isStarted&&this._isPaused}get isStarted(){return this._isStarted}}const R=new o(64,32),ct=8,lt=60,ut=1e3/lt;class _t{constructor(t,e,s,i){r(this,"_renderer");r(this,"_updater");r(this,"_mainClock");r(this,"_selector");r(this,"_lastTime");r(this,"_countedFrames");r(this,"_accumulatedDt");r(this,"_gameEventQueue");this._updater=t,this._renderer=e,this._selector=s,this.gameLoop=this.gameLoop.bind(this),this._mainClock=new ht,this._lastTime=0,this._countedFrames=0,this._accumulatedDt=0,this._gameEventQueue=i}init(){this._mainClock.start()}gameLoop(t,e){const s=this._mainClock.getTicks(),i=s-this._lastTime;this._lastTime=s,this._accumulatedDt+=i,this._selector.updateHoverTile(),this._selector.handleClickEvents(t,e),this._handleEvents(t,e),this._updater.updateTimeline(this._accumulatedDt),this._accumulatedDt>=ut&&(this._renderer.cleanUp(),this._renderer.render(),this._accumulatedDt=0),this._countedFrames+=1,requestAnimationFrame(()=>this.gameLoop(t,e))}_handleEvents(t,e){for(;!this._gameEventQueue.empty();){const s=this._gameEventQueue.dequeue();t.handleEvent(s,e)}}}const C={canvas:{querySelector:"#canvas",background:"#22345c"},menu:{querySelector:"#menu"},splashScreen:{querySelector:"#title-screen"}},v=class v{constructor(t){r(this,"_ctx");r(this,"_canvas");r(this,"_origin");if(this._origin=new o(t),this._canvas=document.querySelector(C.canvas.querySelector),this._canvas==null)throw new N(`
        Canvas unavailable, ensure that a canvas element
        with ${C.canvas.querySelector} query selector is present
        in the index.html file`);if(this._ctx=this._canvas.getContext("2d"),this._ctx==null)throw new N(`
        Rendering context unavailable,
        can't continue
        `);this.paintBackground()}static getInstance(){return v._instance||(v._instance=new v(new o)),v._instance}get canvas(){return this._canvas}updateCanvasSize(t,e){(t!==this._canvas.width||e!==this._canvas.height)&&(this._canvas.width=t,this._canvas.height=e)}paintBackground(){this._ctx.fillStyle=C.canvas.background,this._ctx.fillRect(0,0,this.canvas.width,this.canvas.height)}setFilter(t){this._ctx.filter=t}update(t){t.eventType==="ScaleEvent"?this._canvas.style.scale=t.data.toString():t.eventType==="ResizeEvent"?this.updateCanvasSize(t.data.width,t.data.height):t.eventType==="DragEvent"&&(this._origin=new o(t.data.x,t.data.y))}get origin(){return this._origin}drawImage(t,e,s,i,a){typeof s>"u"?this._ctx.drawImage(t.bitmap,e.x,e.y):typeof i>"u"?this._ctx.drawImage(t.bitmap,e.x,e.y,s.x,s.y):this._ctx.drawImage(t.bitmap,e.x,e.y,s.x,s.y,Math.floor(i.x+this._origin.x),Math.floor(i.y+this._origin.y),a.x,a.y)}};r(v,"_instance");let y=v;class dt{constructor(t,e){r(this,"_context2DProvider");r(this,"_tiles",[]);r(this,"_drawnTiles",[]);r(this,"_cursor");r(this,"_worldMap");this._context2DProvider=y.getInstance(),this._cursor=t,this._worldMap=e}cleanUp(){this._context2DProvider.paintBackground()}render(){for(const t of this._drawnTiles){const e=t.tile.sprite,s=t.drawPos;this._context2DProvider.drawImage(e.spriteSheet.picture,e.spriteSheet.getSpritePosition(e.spriteNb),e.spriteSheet.sizeOfSprite,s,e.spriteSheet.sizeOfSprite),this._drawTileLine(t,this._worldMap.tilesInformations),this._drawHoverTile(t),this._drawTileLine(t,this._worldMap.currentPath),this._drawCharacters(t)}}_drawTileLine(t,e){const s=e.get(t.tile.pos.hash());s!=null&&this._context2DProvider.drawImage(s.sprite.spriteSheet.picture,s.sprite.spriteSheet.getSpritePosition(s.sprite.spriteNb),s.sprite.spriteSheet.sizeOfSprite,t.drawPos,s.sprite.spriteSheet.sizeOfSprite)}_drawHoverTile(t){var e;(e=this._worldMap.hoverTile)!=null&&e.pos.eq(t.tile.pos)&&this._context2DProvider.drawImage(this._cursor.spriteSheet.picture,this._cursor.spriteSheet.getSpritePosition(this._cursor.spriteNb),this._cursor.spriteSheet.sizeOfSprite,t.drawPos,this._cursor.spriteSheet.sizeOfSprite)}_drawCharacters(t){const e=t.tile.pos;for(const s of this._worldMap.characters)if(s!=null&&s.pos.map(Math.ceil).eq(e)){const i=s.tile;this._context2DProvider.drawImage(i.sprite.spriteSheet.picture,i.sprite.spriteSheet.getSpritePosition(i.sprite.spriteNb),i.sprite.spriteSheet.sizeOfSprite,this._getDrawPos(s.pos),i.sprite.spriteSheet.sizeOfSprite)}}set worldmap(t){this._worldMap=t;const e=[...t.tiles.values()];e.sort((s,i)=>{const a=s.pos.x+s.pos.y-(i.pos.x+i.pos.y);return a===0?s.pos.z-i.pos.z:a}),this._tiles=e,this._drawnTiles=this._tiles.map(s=>({drawPos:this._getDrawPos(s.pos),tile:s}))}get drawnTiles(){return this._drawnTiles}_getDrawPos(t){return new o((t.x-t.y)*(R.x/2),(t.x+t.y)*(R.y/2)-t.z*ct)}}class pt{constructor(t){r(this,"_sprites");r(this,"_worldmap");r(this,"_selector");this._sprites=[],this._selector=t}set sprites(t){this._sprites=t}set worldmap(t){this._worldmap=t}updateTimeline(t){var e,s;for(const i of this._sprites)i.updateTimeline(t);(s=this._worldmap)==null||s.update((e=this._selector.hoverTile)==null?void 0:e.tile.pos,t)}}class gt{constructor(t,e){r(this,"_resize_observer");r(this,"_width",0);r(this,"_height",0);r(this,"_canvas");r(this,"_scaleProvider");r(this,"_changeSizeObservers");r(this,"onResize",t=>{for(const e of t){let s,i,a=window.devicePixelRatio;e.devicePixelContentBoxSize?(s=e.devicePixelContentBoxSize[0].inlineSize,i=e.devicePixelContentBoxSize[0].blockSize,a=1):e.contentBoxSize?e.contentBoxSize[0]?(s=e.contentBoxSize[0].inlineSize,i=e.contentBoxSize[0].blockSize):(s=e.contentBoxSize.inlineSize,i=e.contentBoxSize.blockSize):(s=e.contentRect.width,i=e.contentRect.height),this._width=Math.round(s*a),this._height=Math.round(i*a)}this.notifyResize()});this._resize_observer=new ResizeObserver(this.onResize),this._resize_observer.observe(t,{box:"content-box"}),this._canvas=t,this._scaleProvider=e,this._changeSizeObservers=[],this.createWheelEventListener()}addObserver(t){this._changeSizeObservers.push(t)}notifyResize(){const t={data:{width:this._width,height:this._height},eventType:"ResizeEvent"};for(const e of this._changeSizeObservers)e.update(t)}notifyScaleChange(){const t={data:this._scaleProvider.scale,eventType:"ScaleEvent"};for(const e of this._changeSizeObservers)e.update(t)}createWheelEventListener(){this._canvas.addEventListener("wheel",t=>{if(t.preventDefault(),t.stopPropagation(),Math.abs(t.deltaY)<1)return;const e=t.deltaY<0?1:-1,s=this._scaleProvider.scale+e;s<1?this._scaleProvider.scale=1:s>6?this._scaleProvider.scale=6:this._scaleProvider.scale=s,this.notifyScaleChange()},{passive:!1})}get width(){return this._width}get height(){return this._height}}class ft{constructor(t,e){r(this,"_canvas");r(this,"_dragging");r(this,"_drag");r(this,"_dragstart");r(this,"_currentDragging");r(this,"_scale");r(this,"_observers");this._canvas=t,this._dragging=!1,e==null?this._drag=new o:this._drag=new o(e),this._dragstart=new o,this._currentDragging=new o,this._scale=1,this._observers=[],this._canvas.addEventListener("mousedown",s=>{s.preventDefault(),s.stopPropagation(),this._dragging=!0,this._currentDragging=new o(this._drag),this._dragstart.set(s.clientX*window.devicePixelRatio/this._scale,s.clientY*window.devicePixelRatio/this._scale)}),t.addEventListener("mouseup",s=>{s.preventDefault(),s.stopPropagation(),this._dragging=!1}),t.addEventListener("mousemove",s=>{if(!this._dragging)return;const i=new o(s.clientX*window.devicePixelRatio/this._scale,s.clientY*window.devicePixelRatio/this._scale);this._dragstart.almostEq(i,2)||(this.drag=new o(s.clientX*window.devicePixelRatio/this._scale-this._dragstart.x+this._currentDragging.x,s.clientY*window.devicePixelRatio/this._scale-this._dragstart.y+this._currentDragging.y))})}addObserver(t){this._observers.push(t)}notifyChanges(){const t={eventType:"DragEvent",data:{x:this.drag.x,y:this.drag.y}};for(const e of this._observers)e.update(t)}get drag(){return this._drag}set scale(t){this._scale=t}set drag(t){this._drag=new o(t),this.notifyChanges()}update(t){t.eventType==="ScaleEvent"?this._scale=t.data:t.eventType==="ResizeEvent"&&(this.drag=new o(t.data.width/2,t.data.height/2))}}function F(n,t){return t===0?0:n/t}function*L(n,t=void 0){let e=0,s=n;t!=null&&(e=n,s=t);for(let i=e;i<s;i++)yield i}const B=[0,4,3,2.67,2.5,2.4],A=class A{constructor(){r(this,"_mouseVec");r(this,"_scale");r(this,"_canvasSize");this._mouseVec=new o,this._scale=1,this._canvasSize=new o,window.addEventListener("mousemove",t=>{this._mouseVec.set(t.clientX*window.devicePixelRatio/this._scale+F(this._canvasSize.x,B[this._scale-1]),t.clientY*window.devicePixelRatio/this._scale+F(this._canvasSize.y,B[this._scale-1]))})}static getInstance(){return A._instance||(A._instance=new A),A._instance}get pos(){return this._mouseVec}set scale(t){this._scale=t}set canvasSize(t){this._canvasSize.set(t)}update(t){t.eventType==="ScaleEvent"?this._scale=t.data:t.eventType==="ResizeEvent"&&(this._canvasSize=new o(t.data.width,t.data.height))}};r(A,"_instance");let E=A;class wt{constructor(t=1){r(this,"_scale");this._scale=t}get scale(){return this._scale}set scale(t){this._scale=t}}class vt{constructor(){r(this,"_mouse");r(this,"_scaleProvider");r(this,"_context2DProvider");r(this,"_panningListener");r(this,"_changeSizeObserver");this._scaleProvider=new wt(3),this._context2DProvider=y.getInstance(),this._mouse=E.getInstance(),this._panningListener=new ft(this._context2DProvider.canvas,new o(1500,700)),this._changeSizeObserver=new gt(this._context2DProvider.canvas,this._scaleProvider),this._panningListener.addObserver(this._context2DProvider),this._changeSizeObserver.addObserver(this._context2DProvider),this._changeSizeObserver.addObserver(this._mouse),this._changeSizeObserver.addObserver(this._panningListener),this._changeSizeObserver.notifyScaleChange(),this._changeSizeObserver.notifyResize()}}class w{constructor(t,e){r(this,"_pos");r(this,"_sprite");this._pos=t,this._sprite=e}get pos(){return this._pos}get sprite(){return this._sprite}}class _{constructor(t=0,e=0,s=0){r(this,"x");r(this,"y");r(this,"z");t instanceof _?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t,this.y=e,this.z=s)}set(t,e=0,s=0){t instanceof _?(this.x=t.x,this.y=t.y,this.z=t.z):(this.x=t,this.y=e,this.z=s)}add(t){return new _(this.x+t.x,this.y+t.y,this.z+t.z)}sub(t){return new _(this.x-t.x,this.y-t.y,this.z-t.z)}mul(t){return new _(this.x*t,this.y*t,this.z*t)}eq(t){return this.x===t.x&&this.y===t.y&&this.z==t.z}almostEq(t,e){return Math.abs(this.x-t.x)<=e&&Math.abs(this.y-t.y)<=e&&Math.abs(this.z-t.z)<=e}hash(){return JSON.stringify([this.x,this.y,this.z])}static unhash(t){const e=JSON.parse(t);return new _(e[0],e[1],e[2])}map(t){return new _(t(this.x),t(this.y),t(this.z))}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}normalize(){const t=this.length();return new _(this.x/t,this.y/t,this.z/t)}}class J extends Error{constructor(){super(...arguments);r(this,"name","CommonException")}}class At extends J{constructor(t){super(t),this.name="QueueException"}}class mt extends J{constructor(t){super(t),this.name="PriorityQueueException"}}class yt{constructor(){r(this,"_content");this._content=[]}enqueue(t,e){var s=!1;for(let i=0;i<this._content.length;i++)if(this._content[i][1]>e){this._content.splice(i,0,[t,e]),s=!0;break}s||this._content.push([t,e])}dequeue(){const t=this._content.shift();if(t==null)throw new mt("Priority queue is empty");return t}length(){return this._content.length}empty(){return this._content.length==0}}class St{constructor(t){r(this,"_edges",new Map);this._edges=t}has(t){return this._edges.get(t)!=null}neighbors(t){const e=this._edges.get(t);return e??[]}distance(t,e){const s=o.unhash(t),i=o.unhash(e);return Math.abs(i.x-s.x)+Math.abs(i.y-s.y)}getPath(t,e){const s=this.dijkstra(t),i=[];let a=e.hash();for(;a&&(s.get(a)||a==t.hash());)i.push(a),a=s.get(a);return i.map(o.unhash).reverse()}dijkstra(t,e=null){const s=e??new Set,i=new yt,a=new Map,h=new Map,l=t.hash();a.set(l,0),i.enqueue(l,0);for(const c of this._edges.keys())c!=l&&(h.set(c,void 0),a.set(c,1/0));for(;!i.empty();){const[c,g]=i.dequeue();for(const d of this.neighbors(c)){let p;s.has(c)?p=1/0:p=(a.get(c)??0)+this.distance(c,d),p<(a.get(d)??1/0)&&(h.set(d,c),a.set(d,p),i.enqueue(d,p))}}for(const c of s)h.delete(c);return h}}const U=n=>{const t=new Map;for(const[i,a]of n.entries()){const h=_.unhash(i);t.set(new o(h.x,h.y).hash(),a)}const e=new Map;for(const[i,a]of n){const h=new o(o.unhash(i)),l=[],c=[new o(h.x+1,h.y),new o(h.x-1,h.y),new o(h.x,h.y+1),new o(h.x,h.y-1)];for(const g of c)t.get(g.hash())&&l.push(g.hash());e.set(h.hash(),l)}return new St(e)};class xt{constructor(t,e,s){r(this,"_tiles");r(this,"_2DTiles");r(this,"_hoverTile");r(this,"_tileInformationsSprite");r(this,"_pathSprite");r(this,"_characters");r(this,"_tilesInformations");r(this,"_currentPath");r(this,"_currentPathArray");this._tiles=t,this._2DTiles=new Map,this._hoverTile=void 0,this._characters=[],this._tilesInformations=new Map,this._tileInformationsSprite=e,this._currentPath=new Map,this._currentPathArray=[],this._pathSprite=s,this._update2DTiles()}get tileInformationsSprite(){return this._tileInformationsSprite}get pathSprite(){return this._pathSprite}update(t,e){if(this.updateCharacters(e),t==null){this._hoverTile=void 0;return}const s=this.tiles.get(t.hash());if(s==null){this._hoverTile=void 0;return}const i=this._2DTiles.get(new o(s.pos.x,s.pos.y).hash());this._hoverTile=i}updateCharacters(t){for(const e of this._characters)e.update(t)}get hoverTile(){return this._hoverTile}get tiles(){return this._tiles}tile(t){return this.tiles.get(t.hash())}get tiles2D(){return this._2DTiles}set characters(t){this._characters=t}get characters(){return this._characters}set tilesInformations(t){this._tilesInformations=t}get tilesInformations(){return this._tilesInformations}set currentPath(t){this._currentPathArray=[...t],this._currentPath=new Map;for(const e of t){const s=new w(e.pos,this._pathSprite);this._currentPath.set(s.pos.hash(),s)}}get currentPath(){return this._currentPath}get currentPathArray(){return this._currentPathArray}_update2DTiles(){for(let t of this._tiles.values()){const e=new o(t.pos.x,t.pos.y),s=this._2DTiles.get(e.hash());s&&s.pos.z>t.pos.z||this._2DTiles.set(e.hash(),t)}}computeTilesInformations(t,e){const s=[];for(const[i,a]of this._2DTiles)Math.abs(a.pos.x-t.x)+Math.abs(a.pos.y-t.y)<=e&&s.push(new w(a.pos,this.tileInformationsSprite));this.tilesInformations=new Map;for(const i of s)this.tilesInformations.set(i.pos.hash(),i)}getObstacles2DPositions(){const t=new Set;for(const e of this.characters)t.add(new o(e.pos.x,e.pos.y).hash());return t}getCharacterRangeTiles(t,e){const s=this.characters.find(g=>g.pos.eq(t.pos));if(s==null)return[];this.tilesInformations=new Map;const i=s.pos;for(const g of L(i.x-e,i.x+e+1))for(const d of L(i.y-e,i.y+e+1)){if(Math.abs(g-i.x)+Math.abs(d-i.y)>e)continue;const u=this._2DTiles.get(new o(g,d).hash());u!=null&&this.tilesInformations.set(u.pos.hash(),new w(u.pos,this.tileInformationsSprite))}const a=U(this.tilesInformations),h=this.getObstacles2DPositions();h.delete(new o(i.x,i.y).hash());const l=a.dijkstra(new o(i.x,i.y),h),c=new Map;for(const[g,d]of l.entries())if(d!=null){const p=this._2DTiles.get(g);if(p==null)continue;c.set(p.pos.hash(),new w(p.pos,this.tileInformationsSprite))}c.set(i.hash(),new w(i,this.tileInformationsSprite)),this.tilesInformations=c}}class G{constructor(){r(this,"_content");this._content=[]}enqueue(t){this._content.push(t)}peek(){return this._content[0]}dequeue(){const t=this._content.shift();if(t==null)throw new At("The queue is empty");return t}length(){return this._content.length}empty(){return this._content.length==0}}class bt{constructor(t){r(this,"_mouse");r(this,"_hoverTile");r(this,"_cursorPositionOnMouseDown");r(this,"_context2DProvider");r(this,"_renderer");r(this,"_clickEventQueue");this._mouse=E.getInstance(),this._context2DProvider=y.getInstance(),this._hoverTile=void 0,this._cursorPositionOnMouseDown=void 0,this._renderer=t,this._clickEventQueue=new G,this._initMouseDown(),this._initMouseUp()}_initMouseDown(){this._context2DProvider.canvas.addEventListener("mousedown",t=>{this._cursorPositionOnMouseDown=new o(t.clientX,t.clientY)})}_initMouseUp(){this._context2DProvider.canvas.addEventListener("mouseup",t=>{const e=new o(t.clientX,t.clientY);if(!(this._cursorPositionOnMouseDown==null||!this._cursorPositionOnMouseDown.almostEq(e,3)))if(this._hoverTile!=null){const s={tilePos:this._hoverTile.tile.pos,pixel:e,kind:"ClickTileEvent"};this._clickEventQueue.enqueue(s)}else{const s={pixel:e,kind:"ClickPixelEvent"};this._clickEventQueue.enqueue(s)}})}triggerHoverEvent(){if(this._hoverTile==null)return;const t={tilePos:new _(this._hoverTile.tile.pos),pixel:new o(this._hoverTile.drawPos),kind:"HoverEvent"};this._clickEventQueue.enqueue(t)}get hoverTile(){return this._hoverTile}hasPendingEvent(){return!this._clickEventQueue.empty()}getEvent(){return this._clickEventQueue.dequeue()}handleClickEvents(t,e){for(;this.hasPendingEvent();){const s=this.getEvent();t.handleEvent(s,e)}}updateHoverTile(){let t=this._mouse.pos;const e=[];if(this._renderer.drawnTiles.length===0)return;for(let i of this._renderer.drawnTiles){const a=i.tile.sprite.spriteSheet,h=i.drawPos.add(this._context2DProvider.origin);h.x<t.x&&h.x+a.sizeOfSprite.x>=t.x&&h.y<t.y&&h.y+a.sizeOfSprite.y>=t.y&&e.push(i)}const s=[];t=this._mouse.pos.sub(this._context2DProvider.origin),t.set(Math.round(t.x),Math.round(t.y));for(let i of e.reverse()){const a=i.tile.sprite.spriteSheet,h=a.getSpritePosition(i.tile.sprite.spriteNb),l=a.picture.imageData,c=h.y,g=h.x,d=l.width,p=i.drawPos,u=t.sub(p);if(u.x>=a.sizeOfSprite.x||u.y>=a.sizeOfSprite.y)continue;const f=(d*(c+u.y)+(g+u.x))*4;if(l.data[f+3]>0){s.push(i);break}}this._hoverTile!==s[0]&&(this._hoverTile=s[0],!this._hoverTile!=null&&this.triggerHoverEvent())}}class H extends Error{constructor(){super(...arguments);r(this,"name","GameException")}}class z extends H{constructor(t){super(t),this.name="CharacterException"}}class D extends H{constructor(t){super(t),this.name="GameStateException"}}const T=.1;class Q{constructor(t,e,s,i){r(this,"_pos");r(this,"_spriteMap");r(this,"_direction");r(this,"_action");r(this,"_target");r(this,"_gameEventQueue");r(this,"_path");r(this,"_movePerTurn");r(this,"_currentMoveAvailable");this._pos=new _(t),this._spriteMap=e,this._direction="front",this._action="idle",this._target=void 0,this._path=[],this._gameEventQueue=s,this._movePerTurn=i,this._currentMoveAvailable=i}get pos(){return this._pos}get tile(){const t=this._spriteMap.get(JSON.stringify([this._direction,this._action]));if(t==null)throw new z("Unknown sprite");return new w(new _(this._pos),t)}get movePerTurn(){return this._movePerTurn}get currentMoveAvailable(){return this._currentMoveAvailable}set currentMoveAvailable(t){if(t<0){this._currentMoveAvailable=0;return}this._currentMoveAvailable=t}startMoving(t){this._action="walking",this._path=t,this._target=t.shift()}update(t){this._action==="walking"&&this._doWalk(t)}_doWalk(t){if(this._target==null)throw new z("Unable to walk with an empty target");if(this._target.almostEq(this._pos,.01)){if(this._pos.set(this._target),this._path.length==0){this._finishWalk();return}if(this._target=this._path.shift(),this._target==null)return}const e=this._target.sub(this.pos);if(e.x>0)this._direction="right",this._pos.x+=T;else if(e.x<0)this._direction="left",this._pos.x-=T;else if(e.y>0)this._direction="front",this._pos.y+=T;else if(e.y<0)this._direction="back",this._pos.y-=T;else throw new z("Invalid movement");this._pos.z+=e.z}_finishWalk(){this._action="idle",this._target=void 0,this._gameEventQueue.enqueue({kind:"FinishActionEvent"})}}const Y=n=>n.kind=="ClickTileEvent",Pt=n=>n.kind=="ClickPixelEvent",Tt=n=>n.kind=="HoverEvent",Ct=n=>n.kind=="FinishActionEvent",k={handleEvent(n,t,e){if(Y(n)){const s=t.characters.find(i=>i.pos.eq(n.tilePos));if(s==null||!e.activeTeam.hasCharacter(s)){t.tilesInformations=new Map;return}t.getCharacterRangeTiles(s,s.currentMoveAvailable),e.selectedCharacter=s,e.turnStep=X}}},X={handleEvent(n,t,e){if(Y(n)){if(t.tilesInformations.get(n.tilePos.hash())==null){t.tilesInformations=new Map,e.selectedCharacter=void 0,e.turnStep=k;return}if(e.selectedCharacter==null)throw new D("Character can't be null or undefined when game is in 'CharacterSelected' state.");if(t.currentPathArray.length===0)return;const i=t.currentPathArray.map(a=>a.pos);e.selectedCharacter.startMoving(i),e.selectedCharacter.currentMoveAvailable-=i.length,e.turnStep=Et}else Pt(n)&&(t.tilesInformations=new Map,e.selectedCharacter=void 0,e.turnStep=k);if(Tt(n)){if(n.tilePos==null||e.selectedCharacter==null){t.currentPath=[];return}const s=U(t.tilesInformations);if(!s.has(new o(n.tilePos.x,n.tilePos.y).hash())){t.currentPath=[];return}const i=new o(e.selectedCharacter.pos.x,e.selectedCharacter.pos.y),a=s.getPath(i,new o(n==null?void 0:n.tilePos.x,n.tilePos.y));if(a.length===0){t.currentPath=[];return}const h=a.map(l=>t.tiles2D.get(l.hash()));t.currentPath=h}}},Et={handleEvent(n,t,e){if(Ct(n)){const s=e.selectedCharacter;if(s==null)throw new D("A character should be selected while doing action");t.getCharacterRangeTiles(s,s.currentMoveAvailable),t.currentPath=[],e.turnStep=X}}};class zt{constructor(t,e){r(this,"_selectedCharacter");r(this,"_turnStep");r(this,"_teams");r(this,"_activeTeam");this._selectedCharacter=void 0,this._turnStep=k,this._teams=t,this._activeTeam=e}get teams(){return this._teams}get activeTeam(){return this._teams[this._activeTeam]}set activeTeams(t){if(t>=this.teams.length)throw new D("activeTeam should be an existing team");this._activeTeam=t}set turnStep(t){this._turnStep=t}set selectedCharacter(t){this._selectedCharacter=t}get selectedCharacter(){return this._selectedCharacter}handleEvent(t,e){this._turnStep.handleEvent(t,e,this)}}class q{constructor(t){r(this,"_characters");this._characters=t}hasCharacter(t){return this._characters.find(e=>e==t)}}class kt{constructor(){r(this,"_titleScreenContainer");r(this,"_titleScreenStartButton");r(this,"_started");this._titleScreenContainer=document.querySelector(C.splashScreen.querySelector),this._titleScreenStartButton=this._titleScreenContainer.querySelector("button"),this._started=!1,this._initUi()}_initUi(){this._titleScreenStartButton.onclick=()=>{this._started=!0,this._hideTitleScreen()},this._displayTitleScreen()}_displayTitleScreen(){this._titleScreenContainer.style.top="50px",this._titleScreenContainer.style.left="200px"}_hideTitleScreen(){this._titleScreenContainer.style.display="none"}get started(){return this._started}}window.addEventListener("load",async()=>{new vt;const n=await ot(),t=P(n.get("tiles"),[0,1,2,3,4,5,6,8,[{durationMs:500,spriteNb:9},{durationMs:500,spriteNb:10}]]),e=P(n.get("red"),[[{durationMs:400,spriteNb:0},{durationMs:400,spriteNb:1}],[{durationMs:400,spriteNb:4},{durationMs:400,spriteNb:5}],[{durationMs:400,spriteNb:32},{durationMs:400,spriteNb:33}],[{durationMs:400,spriteNb:36},{durationMs:400,spriteNb:37}],[{durationMs:400,spriteNb:16},{durationMs:400,spriteNb:17}],[{durationMs:400,spriteNb:20},{durationMs:400,spriteNb:21}],[{durationMs:400,spriteNb:48},{durationMs:400,spriteNb:49}],[{durationMs:400,spriteNb:52},{durationMs:400,spriteNb:53}]]),s=P(n.get("blue"),[[{durationMs:400,spriteNb:0},{durationMs:400,spriteNb:1}],[{durationMs:400,spriteNb:4},{durationMs:400,spriteNb:5}],[{durationMs:400,spriteNb:32},{durationMs:400,spriteNb:33}],[{durationMs:400,spriteNb:36},{durationMs:400,spriteNb:37}],[{durationMs:400,spriteNb:16},{durationMs:400,spriteNb:17}],[{durationMs:400,spriteNb:20},{durationMs:400,spriteNb:21}],[{durationMs:400,spriteNb:48},{durationMs:400,spriteNb:49}],[{durationMs:400,spriteNb:52},{durationMs:400,spriteNb:53}]]),i=P(n.get("cursor"),[0,1,2,3,4,5,6]),a=t;a.push(...e),a.push(...s),a.push(...i);const h=new Map;for(let S=0;S<8;S++)for(let x=0;x<8;x++)h.set(new _(S,x,0).hash(),new w(new _(S,x,0),t[1]));const l=new xt(h,i[6],i[6]),c=new dt(i[2],l),g=new bt(c),d=new pt(g),p=new G,u=new Map;u.set(JSON.stringify(["front","idle"]),e[0]),u.set(JSON.stringify(["back","idle"]),e[1]),u.set(JSON.stringify(["right","idle"]),e[2]),u.set(JSON.stringify(["left","idle"]),e[3]),u.set(JSON.stringify(["front","walking"]),e[4]),u.set(JSON.stringify(["back","walking"]),e[5]),u.set(JSON.stringify(["right","walking"]),e[6]),u.set(JSON.stringify(["left","walking"]),e[7]);const f=new Map;f.set(JSON.stringify(["front","idle"]),s[0]),f.set(JSON.stringify(["back","idle"]),s[1]),f.set(JSON.stringify(["right","idle"]),s[2]),f.set(JSON.stringify(["left","idle"]),s[3]),f.set(JSON.stringify(["front","walking"]),s[4]),f.set(JSON.stringify(["back","walking"]),s[5]),f.set(JSON.stringify(["right","walking"]),s[6]),f.set(JSON.stringify(["left","walking"]),s[7]),l.characters=[new Q(new _(3,3,0),u,p,3),new Q(new _(5,3,0),f,p,3)];const K=[new q([l.characters[0]]),new q([l.characters[1]])];l.tilesInformations=new Map,d.worldmap=l,d.sprites=a,c.worldmap=l;const I=new _t(d,c,g,p),j=new zt(K,0),W=new kt,Z=setInterval(()=>{W.started==!0&&(clearInterval(Z),I.init(),I.gameLoop(j,l))},250)});
